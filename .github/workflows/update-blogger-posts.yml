name: Get Filtered Blogger Posts
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  get-posts:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: mkdir -p data
    
    - name: Fetch and filter posts
      run: |
        # Obtener y filtrar posts
        curl -s "https://www.googleapis.com/blogger/v3/blogs/$BLOG_ID/posts?key=$API_KEY&maxResults=20" \
          | jq '{
              last_updated: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              posts: [.items[] | {
                title: .title,
                url: .url,
                image: (.content | [match("<img[^>]+src=\"([^\">]+)\"").captures[].string] | first),
                categories: (.labels // []),
                published: .published,
                updated: .updated
              }]
            }' > data/blog-posts.json
        
        echo "‚úÖ Posts procesados: $(jq '.posts | length' data/blog-posts.json)"

    - name: Commit
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add data/blog-posts.json
        git commit -m "üìù Posts actualizados" || exit 0
        git push
      env:
        API_KEY: ${{ secrets.BLOGGER_API_KEY }}
        BLOG_ID: ${{ vars.BLOGGER_BLOG_ID }}
