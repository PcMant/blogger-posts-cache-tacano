name: Get Blogger Posts
on:
  schedule:
    - cron: '0 8 * * *'  # Cada dÃ­a a las 8:00 AM UTC
  workflow_dispatch:       # EjecuciÃ³n manual

jobs:
  get-blogger-posts:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create data directory
      run: mkdir -p data

    - name: Get Blogger posts with error handling
      run: |
        echo "ğŸ“– Obteniendo posts de Blogger..."
        
        # Hacer la peticiÃ³n y guardar el cÃ³digo de respuesta
        HTTP_CODE=$(curl -s -o data/raw-posts.json -w "%{http_code}" \
          "https://www.googleapis.com/blogger/v3/blogs/${{ secrets.BLOGGER_BLOG_ID }}/posts?key=${{ secrets.BLOGGER_API_KEY }}&maxResults=10")
        
        echo "ğŸ“Š CÃ³digo HTTP: $HTTP_CODE"
        
        # Verificar si la peticiÃ³n fue exitosa
        if [ "$HTTP_CODE" -ne 200 ]; then
          echo "âŒ Error en la API: CÃ³digo $HTTP_CODE"
          echo '{"error": "API returned code '"$HTTP_CODE"'", "items": []}' > data/blog-posts.json
          exit 0  # No fallar el workflow, pero crear JSON vacÃ­o
        fi
        
        # Verificar si el JSON tiene datos
        if ! jq -e '.items' data/raw-posts.json > /dev/null 2>&1; then
          echo "âš ï¸  La API no devolviÃ³ posts o respuesta invÃ¡lida"
          echo '{"error": "No posts found or invalid response", "items": []}' > data/blog-posts.json
        else
          # Crear JSON simple con los datos que necesitas
          echo '{"last_updated":"'$(date -Is)'"}' > temp.json
          jq -s '.[0] * .[1]' temp.json data/raw-posts.json > data/blog-posts.json
          rm temp.json
          echo "âœ… Posts obtenidos correctamente"
        fi
        
        # Mostrar informaciÃ³n de debug
        echo "ğŸ“ Contenido del JSON:"
        jq '.' data/blog-posts.json

    - name: Commit and push
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@users.noreply.github.com"
        git add data/blog-posts.json
        git commit -m "ğŸ“ Posts actualizados - $(date +'%Y-%m-%d %H:%M')" || echo "No hay cambios"
        git push
