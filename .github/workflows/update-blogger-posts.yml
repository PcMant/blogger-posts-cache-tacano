name: Get Blogger Posts Robust
on:
  workflow_dispatch:

jobs:
  get-posts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - run: mkdir -p data
    
    - name: Get and process data
      run: |
        # Obtener y procesar en un solo paso
        curl -s "https://www.googleapis.com/blogger/v3/blogs/$BLOG_ID/posts?key=$API_KEY&maxResults=15" | \
        jq '{
          last_updated: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
          posts: [.items[] | {
            title: .title,
            url: .url,
            categories: .labels,
            published: .published,
            updated: .updated
          }]
        }' > data/blog-posts.json
        
        echo "✅ JSON creado directamente"

    - name: Add images in separate step
      run: |
        # Extraer imágenes por separado (más robusto)
        jq '.posts[] | .content' data/raw-response.json > data/contents.txt
        
        # Procesar imágenes si es necesario
        echo "📷 Imágenes serán procesadas en el futuro"

    - name: Commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data/blog-posts.json
        git commit -m "📝 Posts updated - $(date +'%Y-%m-%d')"
        git push
      env:
        API_KEY: ${{ secrets.BLOGGER_API_KEY }}
        BLOG_ID: ${{ vars.BLOGGER_BLOG_ID }}
