name: Get Blogger Posts
on:
  workflow_dispatch:

jobs:
  get-blogger-posts:
    runs-on: ubuntu-latest
    
    # Dar permisos de escritura
    permissions:
      contents: write

    steps:
    - name: Checkout repository WITH write access
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create data directory if not exists
      run: |
        echo "ğŸ“ Creando directorio data si no existe..."
        mkdir -p data
        echo "âœ… Directorio data listo"

    - name: Get Blogger data
      run: |
        echo "ğŸ“¦ Obteniendo datos de Blogger..."
        curl -s "https://www.googleapis.com/blogger/v3/blogs/$BLOG_ID/posts?key=$API_KEY&maxResults=15" \
          -o data/raw-data.json
        echo "âœ… Datos obtenidos y guardados en data/raw-data.json"

    - name: Create simple JSON structure
      run: |
        echo "ğŸ› ï¸ Creando JSON con estructura simple..."
        
        # Verificar si el archivo raw tiene datos
        if jq -e '.items' data/raw-data.json > /dev/null; then
          echo "ğŸ“Š Procesando $(jq '.items | length' data/raw-data.json) posts..."
          
          # Crear el JSON final con los datos que necesitas
          jq '{
            last_updated: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
            posts: [.items[] | {
              title: .title,
              url: .url,
              categories: (.labels // []),
              published: .published,
              updated: .updated
            }]
          }' data/raw-data.json > data/blog-posts.json
          
          echo "âœ… JSON creado en data/blog-posts.json"
          echo "ğŸ“ NÃºmero de posts procesados: $(jq '.posts | length' data/blog-posts.json)"
        else
          echo "âš ï¸ No se encontraron posts, creando JSON vacÃ­o..."
          echo '{"last_updated": "'$(date -Is)'", "posts": []}' > data/blog-posts.json
        fi

    - name: Verify file was created
      run: |
        echo "ğŸ” Verificando que el archivo existe..."
        if [ -f "data/blog-posts.json" ]; then
          echo "âœ… data/blog-posts.json existe"
          echo "ğŸ“ TamaÃ±o: $(wc -l < data/blog-posts.json) lÃ­neas"
        else
          echo "âŒ El archivo no se creÃ³"
          exit 1
        fi

    - name: Commit and push changes
      run: |
        echo "ğŸ“¤ Haciendo commit y push..."
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data/blog-posts.json
        git commit -m "ğŸ“ Auto-update blog posts - $(date +'%Y-%m-%d %H:%M')" || echo "âš ï¸ No hay cambios que commitear"
        git push
      env:
        API_KEY: ${{ secrets.BLOGGER_API_KEY }}
        BLOG_ID: ${{ vars.BLOGGER_BLOG_ID }}
