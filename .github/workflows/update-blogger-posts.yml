name: Get Blogger Posts
on:
  workflow_dispatch:

jobs:
  get-blogger-posts:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create data directory
      run: mkdir -p data

    - name: Get raw Blogger data
      run: |
        echo "ğŸ“¦ Obteniendo datos brutos de Blogger..."
        curl -s "https://www.googleapis.com/blogger/v3/blogs/$BLOG_ID/posts?key=$API_KEY&maxResults=20" \
          -o data/raw-blogger-data.json
        echo "âœ… Datos brutos guardados"

    - name: Create simple JSON structure
      run: |
        echo "ğŸ› ï¸ Creando estructura simple..."
        
        # Crear un JSON bÃ¡sico con los datos que necesitamos
        echo '{
          "last_updated": "'$(date -Is)'",
          "posts": []
        }' > data/blog-posts.json
        
        # Verificar si hay posts
        if jq -e '.items' data/raw-blogger-data.json > /dev/null; then
          # Extraer solo los datos que necesitamos
          jq '.items[] | {
            title: .title,
            url: .url,
            categories: (.labels // []),
            published: .published,
            updated: .updated
          }' data/raw-blogger-data.json > data/temp-posts.json
          
          # Convertir a array y agregar al JSON principal
          jq -s '.posts = $posts' --argjson posts "$(cat data/temp-posts.json | jq -s '.')" data/blog-posts.json > data/final.json
          mv data/final.json data/blog-posts.json
          rm data/temp-posts.json
        fi
        
        echo "âœ… Estructura simple creada"

    - name: Show results
      run: |
        echo "ğŸ“Š Resultado final:"
        jq '.' data/blog-posts.json
        echo "NÃºmero de posts: $(jq '.posts | length' data/blog-posts.json)"

    - name: Commit and push
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@users.noreply.github.com"
        git add data/blog-posts.json
        git commit -m "ğŸ“ Posts actualizados - $(date +'%Y-%m-%d %H:%M')" || echo "No changes to commit"
        git push
      env:
        API_KEY: ${{ secrets.BLOGGER_API_KEY }}
        BLOG_ID: ${{ vars.BLOGGER_BLOG_ID }}
